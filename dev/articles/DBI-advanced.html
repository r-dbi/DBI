<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced DBI Usage • DBI</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Advanced DBI Usage">
<meta property="og:description" content="DBI">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">DBI</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">1.1.3.9009</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/DBI.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-dbi/DBI/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Advanced DBI Usage</h1>
                        <h4 data-toc-skip class="author">James
Wondrasek, Kirill Müller</h4>
            
            <h4 data-toc-skip class="date">17/03/2020</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/r-dbi/DBI/blob/HEAD/vignettes/DBI-advanced.Rmd" class="external-link"><code>vignettes/DBI-advanced.Rmd</code></a></small>
      <div class="hidden name"><code>DBI-advanced.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="who-this-tutorial-is-for">Who this tutorial is for<a class="anchor" aria-label="anchor" href="#who-this-tutorial-is-for"></a>
</h2>
<p>This tutorial is for you if you need to use a richer set of SQL
features such as data manipulation queries, parameterized queries and
queries performed using SQL’s transaction features. See
<code><a href="../articles/DBI.html">vignette("DBI", package = "DBI")</a></code> for a more basic tutorial
covering connecting to DBMS and executing simple queries.</p>
</div>
<div class="section level2">
<h2 id="how-to-run-more-complex-queries-using-dbi">How to run more complex queries using DBI<a class="anchor" aria-label="anchor" href="#how-to-run-more-complex-queries-using-dbi"></a>
</h2>
<p><code><a href="../reference/dbGetQuery.html">dbGetQuery()</a></code> works by calling a number of functions
behind the scenes. If you need more control you can manually build your
own query, retrieve results at your selected rate, and release the
resources involved by calling the same functions.</p>
<p>These functions are:</p>
<ul>
<li>
<code><a href="../reference/dbSendQuery.html">dbSendQuery()</a></code> sends the SQL query to the DBMS and
returns a <code>result</code> object. The query is limited to
<code>SELECT</code> statements. If you want to send other statements,
such as <code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code>,
etc, use <code><a href="../reference/dbSendStatement.html">dbSendStatement()</a></code>.</li>
<li>
<code><a href="../reference/dbFetch.html">dbFetch()</a></code> is called with the <code>result</code> object
returned by <code><a href="../reference/dbSendQuery.html">dbSendQuery()</a></code>. It also accepts an argument
specifying the number of rows to be returned, e.g. <code>n = 200</code>.
If you want to fetch all the rows, use <code>n = -1</code>.</li>
<li>
<code><a href="../reference/dbClearResult.html">dbClearResult()</a></code> is called when you have finished
retrieving data. It releases the resources associated with the
<code>result</code> object.</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org">DBI</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbConnect.html">dbConnect</a></span><span class="op">(</span></span>
<span>  <span class="fu">RMariaDB</span><span class="fu">::</span><span class="fu"><a href="https://rmariadb.r-dbi.org/reference/dbConnect-MariaDBDriver-method.html" class="external-link">MariaDB</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  host <span class="op">=</span> <span class="st">"relational.fit.cvut.cz"</span>,</span>
<span>  port <span class="op">=</span> <span class="fl">3306</span>,</span>
<span>  username <span class="op">=</span> <span class="st">"guest"</span>,</span>
<span>  password <span class="op">=</span> <span class="st">"relational"</span>,</span>
<span>  dbname <span class="op">=</span> <span class="st">"sakila"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbSendQuery.html">dbSendQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"SELECT * FROM film WHERE rating = 'G'"</span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbFetch.html">dbFetch</a></span><span class="op">(</span><span class="va">res</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dbClearResult.html">dbClearResult</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">df</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   film_id            title</span></span>
<span><span class="co">## 1       2   ACE GOLDFINGER</span></span>
<span><span class="co">## 2       4 AFFAIR PREJUDICE</span></span>
<span><span class="co">## 3       5      AFRICAN EGG</span></span>
<span><span class="co">##                                                                                                             description</span></span>
<span><span class="co">## 1                  A Astounding Epistle of a Database Administrator And a Explorer who must Find a Car in Ancient China</span></span>
<span><span class="co">## 2                          A Fanciful Documentary of a Frisbee And a Lumberjack who must Chase a Monkey in A Shark Tank</span></span>
<span><span class="co">## 3 A Fast-Paced Documentary of a Pastry Chef And a Dentist who must Pursue a Forensic Psychologist in The Gulf of Mexico</span></span>
<span><span class="co">##   release_year language_id original_language_id rental_duration rental_rate</span></span>
<span><span class="co">## 1         2006           1                   NA               3        4.99</span></span>
<span><span class="co">## 2         2006           1                   NA               5        2.99</span></span>
<span><span class="co">## 3         2006           1                   NA               6        2.99</span></span>
<span><span class="co">##   length replacement_cost rating               special_features</span></span>
<span><span class="co">## 1     48            12.99      G        Trailers,Deleted Scenes</span></span>
<span><span class="co">## 2    117            26.99      G Commentaries,Behind the Scenes</span></span>
<span><span class="co">## 3    130            22.99      G                 Deleted Scenes</span></span>
<span><span class="co">##           last_update</span></span>
<span><span class="co">## 1 2006-02-15 04:03:42</span></span>
<span><span class="co">## 2 2006-02-15 04:03:42</span></span>
<span><span class="co">## 3 2006-02-15 04:03:42</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="how-to-read-part-of-a-table-from-a-database">How to read part of a table from a database<a class="anchor" aria-label="anchor" href="#how-to-read-part-of-a-table-from-a-database"></a>
</h2>
<p>If your dataset is large you may want to fetch a limited number of
rows at a time. As demonstrated below, this can be accomplished by using
a while loop where the function <code><a href="../reference/dbHasCompleted.html">dbHasCompleted()</a></code> is used to
check for ongoing rows, and <code><a href="../reference/dbFetch.html">dbFetch()</a></code> is used with the
<code>n = X</code> argument, specifying how many rows to return on each
iteration. Again, we call <code><a href="../reference/dbClearResult.html">dbClearResult()</a></code> at the end to
release resources.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbSendQuery.html">dbSendQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"SELECT * FROM film"</span><span class="op">)</span></span>
<span><span class="kw">while</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="../reference/dbHasCompleted.html">dbHasCompleted</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">chunk</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbFetch.html">dbFetch</a></span><span class="op">(</span><span class="va">res</span>, n <span class="op">=</span> <span class="fl">300</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">chunk</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 300</span></span>
<span><span class="co">## [1] 300</span></span>
<span><span class="co">## [1] 300</span></span>
<span><span class="co">## [1] 100</span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dbClearResult.html">dbClearResult</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="how-to-use-parameters-safely-in-sql-queries">How to use parameters (safely) in SQL queries<a class="anchor" aria-label="anchor" href="#how-to-use-parameters-safely-in-sql-queries"></a>
</h2>
<p><code><a href="../reference/dbSendQuery.html">dbSendQuery()</a></code> can be used with parameterized SQL
queries. DBI supports two ways to avoid SQL injection attacks from
user-supplied parameters: quoting and parameterized queries.</p>
<div class="section level3">
<h3 id="quoting">Quoting<a class="anchor" aria-label="anchor" href="#quoting"></a>
</h3>
<p>Quoting of parameter values is performed using the function
<code><a href="../reference/dbQuoteLiteral.html">dbQuoteLiteral()</a></code>, which supports many R data types,
including date and time.<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a></p>
<p>In cases where users may be supplying table or column names to use in
the query for data retrieval, those names or identifiers must also be
escaped. As there may be DBMS-specific rules for escaping these
identifiers, DBI provides the function <code><a href="../reference/dbQuoteIdentifier.html">dbQuoteIdentifier()</a></code>
to generate a safe string representation.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">safe_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbQuoteIdentifier.html">dbQuoteIdentifier</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"rating"</span><span class="op">)</span></span>
<span><span class="va">safe_param</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbQuoteLiteral.html">dbQuoteLiteral</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"G"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">query</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"SELECT title, "</span>, <span class="va">safe_id</span>, <span class="st">" FROM film WHERE "</span>, <span class="va">safe_id</span>, <span class="st">" = "</span>, <span class="va">safe_param</span><span class="op">)</span></span>
<span><span class="va">query</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "SELECT title, `rating` FROM film WHERE `rating` = 'G'"</span></span></code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbSendQuery.html">dbSendQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">query</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dbFetch.html">dbFetch</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##              title rating</span></span>
<span><span class="co">## 1   ACE GOLDFINGER      G</span></span>
<span><span class="co">## 2 AFFAIR PREJUDICE      G</span></span>
<span><span class="co">## 3      AFRICAN EGG      G</span></span>
<span><span class="co">## Showing 3 out of 178 rows.</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dbClearResult.html">dbClearResult</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
<p>The same result can be had by using <code><a href="https://glue.tidyverse.org/reference/glue_sql.html" class="external-link">glue::glue_sql()</a></code>. It
performs the same safe quoting on any variable or R statement appearing
between braces within the query string.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">id</span> <span class="op">&lt;-</span> <span class="st">"rating"</span></span>
<span><span class="va">param</span> <span class="op">&lt;-</span> <span class="st">"G"</span></span>
<span><span class="va">query</span> <span class="op">&lt;-</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue_sql.html" class="external-link">glue_sql</a></span><span class="op">(</span><span class="st">"SELECT title, {`id`} FROM film WHERE {`id`} = {param}"</span>, .con <span class="op">=</span> <span class="va">con</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbGetQuery.html">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">query</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">df</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##              title rating</span></span>
<span><span class="co">## 1   ACE GOLDFINGER      G</span></span>
<span><span class="co">## 2 AFFAIR PREJUDICE      G</span></span>
<span><span class="co">## 3      AFRICAN EGG      G</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="parameterized-queries">Parameterized queries<a class="anchor" aria-label="anchor" href="#parameterized-queries"></a>
</h3>
<p>Rather than performing the parameter substitution ourselves, we can
push it to the DBMS by including placeholders in the query. Different
DBMS use different placeholder schemes, DBI passes through the SQL
expression unchanged.</p>
<p>MariaDB uses a question mark (?) as placeholder and expects an
unnamed list of parameter values. Other DBMS may use named parameters.
We recommend consulting the documentation for the DBMS you are using. As
an example, a web search for “mariadb parameterized queries” leads to
the documentation for the <a href="https://mariadb.com/kb/en/prepare-statement/" class="external-link"><code>PREPARE</code>
statement</a> which mentions:</p>
<blockquote>
<p>Within the statement, “?” characters can be used as parameter markers
to indicate where data values are to be bound to the query later when
you execute it.</p>
</blockquote>
<p>Currently there is no list of which placeholder scheme a particular
DBMS supports.</p>
<p>Placeholders only work for literal values. Other parts of the query,
e.g. table or column identifiers, still need to be quoted with
<code><a href="../reference/dbQuoteIdentifier.html">dbQuoteIdentifier()</a></code>.</p>
<p>For a single set of parameters, the <code>params</code> argument to
<code><a href="../reference/dbSendQuery.html">dbSendQuery()</a></code> or <code><a href="../reference/dbGetQuery.html">dbGetQuery()</a></code> can be used. It
takes a list and its members are substituted in order for the
placeholders within the query.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"G"</span><span class="op">)</span></span>
<span><span class="va">safe_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbQuoteIdentifier.html">dbQuoteIdentifier</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"rating"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">query</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"SELECT * FROM film WHERE "</span>, <span class="va">safe_id</span>, <span class="st">" = ?"</span><span class="op">)</span></span>
<span><span class="va">query</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "SELECT * FROM film WHERE `rating` = ?"</span></span></code></pre>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbSendQuery.html">dbSendQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">query</span>, params <span class="op">=</span> <span class="va">params</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dbFetch.html">dbFetch</a></span><span class="op">(</span><span class="va">res</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   film_id            title</span></span>
<span><span class="co">## 1       2   ACE GOLDFINGER</span></span>
<span><span class="co">## 2       4 AFFAIR PREJUDICE</span></span>
<span><span class="co">## 3       5      AFRICAN EGG</span></span>
<span><span class="co">##                                                                                                             description</span></span>
<span><span class="co">## 1                  A Astounding Epistle of a Database Administrator And a Explorer who must Find a Car in Ancient China</span></span>
<span><span class="co">## 2                          A Fanciful Documentary of a Frisbee And a Lumberjack who must Chase a Monkey in A Shark Tank</span></span>
<span><span class="co">## 3 A Fast-Paced Documentary of a Pastry Chef And a Dentist who must Pursue a Forensic Psychologist in The Gulf of Mexico</span></span>
<span><span class="co">##   release_year language_id original_language_id rental_duration rental_rate</span></span>
<span><span class="co">## 1         2006           1                   NA               3        4.99</span></span>
<span><span class="co">## 2         2006           1                   NA               5        2.99</span></span>
<span><span class="co">## 3         2006           1                   NA               6        2.99</span></span>
<span><span class="co">##   length replacement_cost rating               special_features</span></span>
<span><span class="co">## 1     48            12.99      G        Trailers,Deleted Scenes</span></span>
<span><span class="co">## 2    117            26.99      G Commentaries,Behind the Scenes</span></span>
<span><span class="co">## 3    130            22.99      G                 Deleted Scenes</span></span>
<span><span class="co">##           last_update</span></span>
<span><span class="co">## 1 2006-02-15 04:03:42</span></span>
<span><span class="co">## 2 2006-02-15 04:03:42</span></span>
<span><span class="co">## 3 2006-02-15 04:03:42</span></span></code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dbClearResult.html">dbClearResult</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
<p>Below is an example query using multiple placeholders with the
MariaDB driver. The placeholders are supplied as a list of values
ordered to match the position of the placeholders in the query.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">q_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"G"</span>, <span class="fl">90</span><span class="op">)</span></span>
<span><span class="va">query</span> <span class="op">&lt;-</span> <span class="st">"SELECT title, rating, length FROM film WHERE rating = ? AND length &gt;= ?"</span></span>
<span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbSendQuery.html">dbSendQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">query</span>, params <span class="op">=</span> <span class="va">q_params</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dbFetch.html">dbFetch</a></span><span class="op">(</span><span class="va">res</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##              title rating length</span></span>
<span><span class="co">## 1 AFFAIR PREJUDICE      G    117</span></span>
<span><span class="co">## 2      AFRICAN EGG      G    130</span></span>
<span><span class="co">## 3  ALAMO VIDEOTAPE      G    126</span></span></code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dbClearResult.html">dbClearResult</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
<p>When you wish to perform the same query with different sets of
parameter values, <code><a href="../reference/dbBind.html">dbBind()</a></code> is used. There are two ways to
use <code><a href="../reference/dbBind.html">dbBind()</a></code>. Firstly, it can be used multiple times with
same query.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbSendQuery.html">dbSendQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"SELECT * FROM film WHERE rating = ?"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dbBind.html">dbBind</a></span><span class="op">(</span><span class="va">res</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"G"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dbFetch.html">dbFetch</a></span><span class="op">(</span><span class="va">res</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   film_id            title</span></span>
<span><span class="co">## 1       2   ACE GOLDFINGER</span></span>
<span><span class="co">## 2       4 AFFAIR PREJUDICE</span></span>
<span><span class="co">## 3       5      AFRICAN EGG</span></span>
<span><span class="co">##                                                                                                             description</span></span>
<span><span class="co">## 1                  A Astounding Epistle of a Database Administrator And a Explorer who must Find a Car in Ancient China</span></span>
<span><span class="co">## 2                          A Fanciful Documentary of a Frisbee And a Lumberjack who must Chase a Monkey in A Shark Tank</span></span>
<span><span class="co">## 3 A Fast-Paced Documentary of a Pastry Chef And a Dentist who must Pursue a Forensic Psychologist in The Gulf of Mexico</span></span>
<span><span class="co">##   release_year language_id original_language_id rental_duration rental_rate</span></span>
<span><span class="co">## 1         2006           1                   NA               3        4.99</span></span>
<span><span class="co">## 2         2006           1                   NA               5        2.99</span></span>
<span><span class="co">## 3         2006           1                   NA               6        2.99</span></span>
<span><span class="co">##   length replacement_cost rating               special_features</span></span>
<span><span class="co">## 1     48            12.99      G        Trailers,Deleted Scenes</span></span>
<span><span class="co">## 2    117            26.99      G Commentaries,Behind the Scenes</span></span>
<span><span class="co">## 3    130            22.99      G                 Deleted Scenes</span></span>
<span><span class="co">##           last_update</span></span>
<span><span class="co">## 1 2006-02-15 04:03:42</span></span>
<span><span class="co">## 2 2006-02-15 04:03:42</span></span>
<span><span class="co">## 3 2006-02-15 04:03:42</span></span></code></pre>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dbBind.html">dbBind</a></span><span class="op">(</span><span class="va">res</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"PG"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dbFetch.html">dbFetch</a></span><span class="op">(</span><span class="va">res</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   film_id            title</span></span>
<span><span class="co">## 1       1 ACADEMY DINOSAUR</span></span>
<span><span class="co">## 2       6     AGENT TRUMAN</span></span>
<span><span class="co">## 3      12   ALASKA PHANTOM</span></span>
<span><span class="co">##                                                                                        description</span></span>
<span><span class="co">## 1 A Epic Drama of a Feminist And a Mad Scientist who must Battle a Teacher in The Canadian Rockies</span></span>
<span><span class="co">## 2        A Intrepid Panorama of a Robot And a Boy who must Escape a Sumo Wrestler in Ancient China</span></span>
<span><span class="co">## 3               A Fanciful Saga of a Hunter And a Pastry Chef who must Vanquish a Boy in Australia</span></span>
<span><span class="co">##   release_year language_id original_language_id rental_duration rental_rate</span></span>
<span><span class="co">## 1         2006           1                   NA               6        0.99</span></span>
<span><span class="co">## 2         2006           1                   NA               3        2.99</span></span>
<span><span class="co">## 3         2006           1                   NA               6        0.99</span></span>
<span><span class="co">##   length replacement_cost rating                 special_features</span></span>
<span><span class="co">## 1     86            20.99     PG Deleted Scenes,Behind the Scenes</span></span>
<span><span class="co">## 2    169            17.99     PG                   Deleted Scenes</span></span>
<span><span class="co">## 3    136            22.99     PG      Commentaries,Deleted Scenes</span></span>
<span><span class="co">##           last_update</span></span>
<span><span class="co">## 1 2006-02-15 04:03:42</span></span>
<span><span class="co">## 2 2006-02-15 04:03:42</span></span>
<span><span class="co">## 3 2006-02-15 04:03:42</span></span></code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dbClearResult.html">dbClearResult</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
<p>Secondly, <code><a href="../reference/dbBind.html">dbBind()</a></code> can be used to execute the same
statement with multiple values at once.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbSendQuery.html">dbSendQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"SELECT * FROM film WHERE rating = ?"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dbBind.html">dbBind</a></span><span class="op">(</span><span class="va">res</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"G"</span>, <span class="st">"PG"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dbFetch.html">dbFetch</a></span><span class="op">(</span><span class="va">res</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   film_id            title</span></span>
<span><span class="co">## 1       2   ACE GOLDFINGER</span></span>
<span><span class="co">## 2       4 AFFAIR PREJUDICE</span></span>
<span><span class="co">## 3       5      AFRICAN EGG</span></span>
<span><span class="co">##                                                                                                             description</span></span>
<span><span class="co">## 1                  A Astounding Epistle of a Database Administrator And a Explorer who must Find a Car in Ancient China</span></span>
<span><span class="co">## 2                          A Fanciful Documentary of a Frisbee And a Lumberjack who must Chase a Monkey in A Shark Tank</span></span>
<span><span class="co">## 3 A Fast-Paced Documentary of a Pastry Chef And a Dentist who must Pursue a Forensic Psychologist in The Gulf of Mexico</span></span>
<span><span class="co">##   release_year language_id original_language_id rental_duration rental_rate</span></span>
<span><span class="co">## 1         2006           1                   NA               3        4.99</span></span>
<span><span class="co">## 2         2006           1                   NA               5        2.99</span></span>
<span><span class="co">## 3         2006           1                   NA               6        2.99</span></span>
<span><span class="co">##   length replacement_cost rating               special_features</span></span>
<span><span class="co">## 1     48            12.99      G        Trailers,Deleted Scenes</span></span>
<span><span class="co">## 2    117            26.99      G Commentaries,Behind the Scenes</span></span>
<span><span class="co">## 3    130            22.99      G                 Deleted Scenes</span></span>
<span><span class="co">##           last_update</span></span>
<span><span class="co">## 1 2006-02-15 04:03:42</span></span>
<span><span class="co">## 2 2006-02-15 04:03:42</span></span>
<span><span class="co">## 3 2006-02-15 04:03:42</span></span></code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dbClearResult.html">dbClearResult</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
<p>Use a list of vectors if your query has multiple parameters:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">q_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"G"</span>, <span class="st">"PG"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">90</span>, <span class="fl">120</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">query</span> <span class="op">&lt;-</span> <span class="st">"SELECT title, rating, length FROM film WHERE rating = ? AND length &gt;= ?"</span></span>
<span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbSendQuery.html">dbSendQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">query</span>, params <span class="op">=</span> <span class="va">q_params</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dbFetch.html">dbFetch</a></span><span class="op">(</span><span class="va">res</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##              title rating length</span></span>
<span><span class="co">## 1 AFFAIR PREJUDICE      G    117</span></span>
<span><span class="co">## 2      AFRICAN EGG      G    130</span></span>
<span><span class="co">## 3  ALAMO VIDEOTAPE      G    126</span></span></code></pre>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dbClearResult.html">dbClearResult</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
<p>Always disconnect from the database when done.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dbDisconnect.html">dbDisconnect</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="sql-data-manipulation---update-delete-and-friends">SQL data manipulation - UPDATE, DELETE and friends<a class="anchor" aria-label="anchor" href="#sql-data-manipulation---update-delete-and-friends"></a>
</h2>
<p>For SQL queries that affect the underlying database, such as UPDATE,
DELETE, INSERT INTO, and DROP TABLE, DBI provides two functions.
<code><a href="../reference/dbExecute.html">dbExecute()</a></code> passes the SQL statement to the DBMS for
execution and returns the number of rows affected.
<code><a href="../reference/dbSendStatement.html">dbSendStatement()</a></code> performs in the same manner, but returns
a result object. Call <code><a href="../reference/dbGetRowsAffected.html">dbGetRowsAffected()</a></code> with the result
object to get the count of the affected rows. You then need to call
<code><a href="../reference/dbClearResult.html">dbClearResult()</a></code> with the result object afterwards to
release resources.</p>
<p>In actuality, <code><a href="../reference/dbExecute.html">dbExecute()</a></code> is a convenience function that
calls <code><a href="../reference/dbSendStatement.html">dbSendStatement()</a></code>, <code><a href="../reference/dbGetRowsAffected.html">dbGetRowsAffected()</a></code>,
and <code><a href="../reference/dbClearResult.html">dbClearResult()</a></code>. You can use these functions if you
need more control over the query process.</p>
<p>The subsequent examples use an in-memory SQL database provided by
<code><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">RSQLite::SQLite()</a></code>, because the remote database used in
above examples does not allow writing.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org">DBI</a></span><span class="op">)</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbConnect.html">dbConnect</a></span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">":memory:"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/dbWriteTable.html">dbWriteTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"cars"</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cars</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/dbExecute.html">dbExecute</a></span><span class="op">(</span></span>
<span>  <span class="va">con</span>,</span>
<span>  <span class="st">"INSERT INTO cars (speed, dist) VALUES (1, 1), (2, 2), (3, 3)"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 3</span></span></code></pre>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbSendStatement.html">dbSendStatement</a></span><span class="op">(</span></span>
<span>  <span class="va">con</span>,</span>
<span>  <span class="st">"INSERT INTO cars (speed, dist) VALUES (4, 4), (5, 5), (6, 6)"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dbGetRowsAffected.html">dbGetRowsAffected</a></span><span class="op">(</span><span class="va">rs</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 3</span></span></code></pre>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dbClearResult.html">dbClearResult</a></span><span class="op">(</span><span class="va">rs</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/dbReadTable.html">dbReadTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"cars"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   speed dist</span></span>
<span><span class="co">## 1     4    2</span></span>
<span><span class="co">## 2     4   10</span></span>
<span><span class="co">## 3     7    4</span></span>
<span><span class="co">## Showing 3 out of 9 rows.</span></span></code></pre>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dbDisconnect.html">dbDisconnect</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="sql-transactions-with-dbi">SQL transactions with DBI<a class="anchor" aria-label="anchor" href="#sql-transactions-with-dbi"></a>
</h2>
<p>DBI allows you to group multiple queries into a single atomic
transaction. Transactions are initiated with <code><a href="../reference/transactions.html">dbBegin()</a></code> and
either made persistent with <code><a href="../reference/transactions.html">dbCommit()</a></code> or undone with
<code><a href="../reference/transactions.html">dbRollback()</a></code>. The example below updates two tables and
ensures that either both tables are updated, or no changes are persisted
to the database and an error is thrown.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbConnect.html">dbConnect</a></span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">":memory:"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/dbWriteTable.html">dbWriteTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"cash"</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>amount <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dbWriteTable.html">dbWriteTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"account"</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>amount <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">withdraw</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">amount</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># All operations must be carried out as logical unit:</span></span>
<span>  <span class="fu"><a href="../reference/dbExecute.html">dbExecute</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"UPDATE cash SET amount = amount + ?"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">amount</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/dbExecute.html">dbExecute</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"UPDATE account SET amount = amount - ?"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">amount</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">withdraw_transacted</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">amount</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Ensure atomicity</span></span>
<span>  <span class="fu"><a href="../reference/transactions.html">dbBegin</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Perform operation</span></span>
<span>  <span class="fu">withdraw</span><span class="op">(</span><span class="va">amount</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Persist results</span></span>
<span>  <span class="fu"><a href="../reference/transactions.html">dbCommit</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">withdraw_transacted</span><span class="op">(</span><span class="fl">300</span><span class="op">)</span></span></code></pre></div>
<p>After withdrawing 300 credits, the cash is increased and the account
is decreased by this amount. The transaction ensures that either both
operations succeed, or no change occurs.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dbReadTable.html">dbReadTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"cash"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   amount</span></span>
<span><span class="co">## 1    400</span></span></code></pre>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dbReadTable.html">dbReadTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"account"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   amount</span></span>
<span><span class="co">## 1   1700</span></span></code></pre>
<p>We can roll back changes manually if necessary. Do not forget to call
<code><a href="../reference/transactions.html">dbRollback()</a></code> in case of error, otherwise the transaction
remains open indefinitely.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">withdraw_if_funds</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">amount</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/transactions.html">dbBegin</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span>
<span>  <span class="fu">withdraw</span><span class="op">(</span><span class="va">amount</span><span class="op">)</span></span>
<span>  <span class="co"># Rolling back after detecting negative value on account:</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="../reference/dbReadTable.html">dbReadTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"account"</span><span class="op">)</span><span class="op">$</span><span class="va">amount</span> <span class="op">&gt;=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/transactions.html">dbCommit</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span>
<span>    <span class="cn">TRUE</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Insufficient funds"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="../reference/transactions.html">dbRollback</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span>
<span>    <span class="cn">FALSE</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">withdraw_if_funds</span><span class="op">(</span><span class="fl">5000</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Insufficient funds</span></span></code></pre>
<pre><code><span><span class="co">## [1] FALSE</span></span></code></pre>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dbReadTable.html">dbReadTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"cash"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   amount</span></span>
<span><span class="co">## 1    400</span></span></code></pre>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dbReadTable.html">dbReadTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"account"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   amount</span></span>
<span><span class="co">## 1   1700</span></span></code></pre>
<p><code><a href="../reference/dbWithTransaction.html">dbWithTransaction()</a></code> simplifies using transactions. Pass
it a connection and the code you want to run as a transaction. It will
execute the code and call <code><a href="../reference/transactions.html">dbCommit()</a></code> on success and call
<code><a href="../reference/transactions.html">dbRollback()</a></code> if an error is thrown.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">withdraw_safely</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">amount</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/dbWithTransaction.html">dbWithTransaction</a></span><span class="op">(</span><span class="va">con</span>, <span class="op">{</span></span>
<span>    <span class="fu">withdraw</span><span class="op">(</span><span class="va">amount</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="../reference/dbReadTable.html">dbReadTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"account"</span><span class="op">)</span><span class="op">$</span><span class="va">amount</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Error: insufficient funds"</span>, call. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">withdraw_safely</span><span class="op">(</span><span class="fl">5000</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error: Error: insufficient funds</span></span></code></pre>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dbReadTable.html">dbReadTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"cash"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   amount</span></span>
<span><span class="co">## 1    400</span></span></code></pre>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dbReadTable.html">dbReadTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"account"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   amount</span></span>
<span><span class="co">## 1   1700</span></span></code></pre>
<p>As usual, do not forget to disconnect from the database when
done.</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dbDisconnect.html">dbDisconnect</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>That concludes the major features of DBI. For more details on the
library functions covered in this tutorial and the
<code><a href="../articles/DBI.html">vignette("DBI", package = "DBI")</a></code> introductory tutorial see
the DBI specification at <code><a href="../articles/spec.html">vignette("spec", package = "DBI")</a></code>.
If you are after a data manipulation library that works at a higher
level of abstraction, check out <a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a>. It is a grammar of data
manipulation that can work with local dataframes and remote databases
and uses DBI under the hood.</p>
</div>
<div class="footnotes footnotes-end-of-document">
<hr>
<ol>
<li id="fn1"><p>An older method, <code><a href="../reference/dbQuoteString.html">dbQuoteString()</a></code>, was used
to quote string values only. The <code><a href="../reference/dbQuoteLiteral.html">dbQuoteLiteral()</a></code> method
forwards to <code><a href="../reference/dbQuoteString.html">dbQuoteString()</a></code> for character vectors. Users do
not need to distinguish between these two cases.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by R Special Interest Group on Databases (R-SIG-DB), Hadley Wickham, <a href="https://krlmlr.info" class="external-link">Kirill Müller</a>, R Consortium.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.9000.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>

<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Self-contained SQL transactions — dbWithTransaction • DBI</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Self-contained SQL transactions — dbWithTransaction"><meta name="description" content="Given that transactions are implemented, this function
allows you to pass in code that is run in a transaction.
The default method of dbWithTransaction() calls dbBegin()
before executing the code,
and dbCommit() after successful completion,
or dbRollback() in case of an error.
The advantage is
that you don't have to remember to do dbBegin() and dbCommit() or
dbRollback() – that is all taken care of.
The special function dbBreak() allows an early exit with rollback,
it can be called only inside dbWithTransaction().

Methods in other packagesThis documentation page describes the generics. Refer to the documentation pages linked below for the documentation for the methods that are implemented in various backend packages.
pool::dbWithTransaction(&quot;Pool&quot;)

"><meta property="og:description" content="Given that transactions are implemented, this function
allows you to pass in code that is run in a transaction.
The default method of dbWithTransaction() calls dbBegin()
before executing the code,
and dbCommit() after successful completion,
or dbRollback() in case of an error.
The advantage is
that you don't have to remember to do dbBegin() and dbCommit() or
dbRollback() – that is all taken care of.
The special function dbBreak() allows an early exit with rollback,
it can be called only inside dbWithTransaction().

Methods in other packagesThis documentation page describes the generics. Refer to the documentation pages linked below for the documentation for the methods that are implemented in various backend packages.
pool::dbWithTransaction(&quot;Pool&quot;)

"><meta name="robots" content="noindex"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">DBI</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.2.3.9033</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/DBI.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-dbi/DBI/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Self-contained SQL transactions</h1>
      <small class="dont-index">Source: <a href="https://github.com/r-dbi/DBI/blob/main/R/dbWithTransaction.R" class="external-link"><code>R/dbWithTransaction.R</code></a>, <a href="https://github.com/r-dbi/DBI/blob/main/R/dbWithTransaction_DBIConnection.R" class="external-link"><code>R/dbWithTransaction_DBIConnection.R</code></a></small>
      <div class="d-none name"><code>dbWithTransaction.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Given that <a href="transactions.html">transactions</a> are implemented, this function
allows you to pass in code that is run in a transaction.
The default method of <code>dbWithTransaction()</code> calls <code><a href="transactions.html">dbBegin()</a></code>
before executing the code,
and <code><a href="transactions.html">dbCommit()</a></code> after successful completion,
or <code><a href="transactions.html">dbRollback()</a></code> in case of an error.
The advantage is
that you don't have to remember to do <code><a href="transactions.html">dbBegin()</a></code> and <code><a href="transactions.html">dbCommit()</a></code> or
<code><a href="transactions.html">dbRollback()</a></code> – that is all taken care of.
The special function <code>dbBreak()</code> allows an early exit with rollback,
it can be called only inside <code>dbWithTransaction()</code>.</p>
<p></p><div class="section">
<h3 id="methods-in-other-packages">Methods in other packages<a class="anchor" aria-label="anchor" href="#methods-in-other-packages"></a></h3><p>This documentation page describes the generics. Refer to the documentation pages linked below for the documentation for the methods that are implemented in various backend packages.</p><ul><li><p><code><a href="http://rstudio.github.io/pool/reference/DBI-custom.html" class="external-link">pool::dbWithTransaction("Pool")</a></code></p></li>
</ul></div>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">dbWithTransaction</span><span class="op">(</span><span class="va">conn</span>, <span class="va">code</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">dbBreak</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-conn">conn<a class="anchor" aria-label="anchor" href="#arg-conn"></a></dt>
<dd><p>A <a href="DBIConnection-class.html">DBI::DBIConnection</a> object,
as returned by <code><a href="dbConnect.html">dbConnect()</a></code>.</p></dd>


<dt id="arg-code">code<a class="anchor" aria-label="anchor" href="#arg-code"></a></dt>
<dd><p>An arbitrary block of R code.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Other parameters passed on to methods.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p><code>dbWithTransaction()</code> returns the value of the executed code.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>DBI implements <code>dbWithTransaction()</code>, backends should need to override this
generic only if they implement specialized handling.</p>
    </div>
    <div class="section level2">
    <h2 id="failure-modes">Failure modes<a class="anchor" aria-label="anchor" href="#failure-modes"></a></h2>



<p>Failure to initiate the transaction
(e.g., if the connection is closed
or invalid
or if <code><a href="transactions.html">DBI::dbBegin()</a></code> has been called already)
gives an error.</p>
    </div>
    <div class="section level2">
    <h2 id="specification">Specification<a class="anchor" aria-label="anchor" href="#specification"></a></h2>



<p><code>dbWithTransaction()</code> initiates a transaction with <code><a href="transactions.html">dbBegin()</a></code>, executes
the code given in the <code>code</code> argument, and commits the transaction with
<code><a href="transactions.html">DBI::dbCommit()</a></code>.
If the code raises an error, the transaction is instead aborted with
<code><a href="transactions.html">DBI::dbRollback()</a></code>, and the error is propagated.
If the code calls <code>dbBreak()</code>, execution of the code stops and the
transaction is silently aborted.
All side effects caused by the code
(such as the creation of new variables)
propagate to the calling environment.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="dbConnect.html">dbConnect</a></span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">":memory:"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="dbWriteTable.html">dbWriteTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"cash"</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>amount <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="dbWriteTable.html">dbWriteTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"account"</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>amount <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># All operations are carried out as logical unit:</span></span></span>
<span class="r-in"><span><span class="fu">dbWithTransaction</span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">con</span>,</span></span>
<span class="r-in"><span>  <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="va">withdrawal</span> <span class="op">&lt;-</span> <span class="fl">300</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="dbExecute.html">dbExecute</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"UPDATE cash SET amount = amount + ?"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">withdrawal</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="dbExecute.html">dbExecute</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"UPDATE account SET amount = amount - ?"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">withdrawal</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 1</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># The code is executed as if in the current environment:</span></span></span>
<span class="r-in"><span><span class="va">withdrawal</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 300</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># The changes are committed to the database after successful execution:</span></span></span>
<span class="r-in"><span><span class="fu"><a href="dbReadTable.html">dbReadTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"cash"</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   amount</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1    400</span>
<span class="r-in"><span><span class="fu"><a href="dbReadTable.html">dbReadTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"account"</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   amount</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1   1700</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Rolling back with dbBreak():</span></span></span>
<span class="r-in"><span><span class="fu">dbWithTransaction</span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">con</span>,</span></span>
<span class="r-in"><span>  <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="va">withdrawal</span> <span class="op">&lt;-</span> <span class="fl">5000</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="dbExecute.html">dbExecute</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"UPDATE cash SET amount = amount + ?"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">withdrawal</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="dbExecute.html">dbExecute</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"UPDATE account SET amount = amount - ?"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">withdrawal</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="dbReadTable.html">dbReadTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"account"</span><span class="op">)</span><span class="op">$</span><span class="va">amount</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>      <span class="fu">dbBreak</span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="op">}</span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># These changes were not committed to the database:</span></span></span>
<span class="r-in"><span><span class="fu"><a href="dbReadTable.html">dbReadTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"cash"</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   amount</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1    400</span>
<span class="r-in"><span><span class="fu"><a href="dbReadTable.html">dbReadTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"account"</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   amount</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1   1700</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="dbDisconnect.html">dbDisconnect</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by R Special Interest Group on Databases (R-SIG-DB), <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://krlmlr.info" class="external-link">Kirill Müller</a>, R Consortium.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.9000.</p>
</div>

    </footer></div>





  </body></html>

